<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - AuthApp</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="home-container">
    <header class="header">
      <a href="/" class="logo">AuthApp</a>
      <div class="header-buttons">
        <span class="muted">Welcome, {{ user }}</span>
        <a href="/logout"><button class="btn btn-secondary">Logout</button></a>
      </div>
    </header>

    <main class="main-content">
      <div class="dashboard">
        <aside class="sidebar">
          <div class="sidebar-title">Tools</div>
          <nav class="sidebar-nav">
            <button class="nav-item active" data-panel="apple-panel">üçé Apple Identification</button>
          </nav>
        </aside>

        <section class="workspace">
          <div id="welcome" class="welcome">
            <h1 class="brand-title">Dashboard</h1>
            <p class="brand-subtitle">Choose a tool from the left to get started.</p>
          </div>

          <div id="apple-panel" class="panel">
            <h2 class="panel-title">Apple Identification</h2>

            <div class="feature-tabs">
              <button class="tab active" data-tab="webcam">Webcam</button>
              <button class="tab" data-tab="image">Image Upload</button>
              <button class="tab" data-tab="video">Video Upload</button>
              <button class="tab" data-tab="history">History</button>
            </div>

            <div class="feature-views">
              <div class="feature-view" id="view-webcam">
                <div class="media-box">
                  <video id="liveVideo" autoplay playsinline muted style="display:none;"></video>
                  <canvas id="captureCanvas" style="display:none;"></canvas>
                  <img id="webcamImgTag" alt="Webcam MJPEG" style="display:none; width:640px; height:360px;" />
                </div>
                <div class="btn-group" style="margin-top:12px;">
                  <button id="startImgStream" class="btn btn-primary" type="button">Start Stream</button>
                  <button id="pauseImgStream" class="btn btn-secondary" type="button">Pause</button>
                  <button id="stopWebcamStream" class="btn btn-secondary" type="button">Stop</button>
                </div>
              </div>

              <div class="feature-view hidden" id="view-image">
                <div class="upload-box">
                  <input id="imageInput" type="file" accept="image/*" />
                  <button id="uploadImage" class="btn btn-primary" type="button" style="margin-top:12px;">Analyze Image</button>
                </div>
              </div>

              <div class="feature-view hidden" id="view-video">
                <div class="upload-box">
                  <input id="videoInput" type="file" accept="video/*" />
                  <div class="btn-group" style="margin-top:12px;">
                    <button id="startFileStream" class="btn btn-primary" type="button">Start</button>
                    <button id="pauseFileStream" class="btn btn-secondary" type="button">Pause</button>
                    <button id="stopFileStream" class="btn btn-secondary" type="button">Stop</button>
                  </div>
                </div>
                <div class="media-box" style="margin-top:12px;">
                  <img id="fileStreamImg" alt="File Stream" style="display:none; width:640px; height:360px;" />
                </div>
              </div>

              <div class="feature-view hidden" id="view-history">
                <div class="panel" style="box-shadow:none; padding:0; background:transparent;">
                  <div class="btn-group" style="margin-bottom:12px;">
                    <button id="clearHistory" class="btn btn-secondary" type="button">Clear History</button>
                  </div>
                  <div style="overflow:auto; background:#fff; border-radius:12px; border:1px solid #e3e9ff;">
                    <table id="historyTable" style="width:100%; border-collapse:collapse;">
                      <thead>
                        <tr style="background:#f6f8ff; color:#2b3a84;">
                          <th style="text-align:left; padding:10px 12px;">Type</th>
                          <th style="text-align:left; padding:10px 12px;">File/Source</th>
                          <th style="text-align:left; padding:10px 12px;">Start Time</th>
                          <th style="text-align:left; padding:10px 12px;">End Time</th>
                          <th style="text-align:left; padding:10px 12px;">Apples Detected</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div id="result" class="result hidden">
              <div class="result-count"><strong>Apples Detected:</strong> <span id="appleCount">0</span></div>
              <img id="resultImage" alt="Result" />
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="footer">
      <div class="footer-content">
        <div>&copy; 2024 AuthApp. All rights reserved.</div>
        <div class="social-links">
          <a href="#" title="Twitter">üì±</a>
          <a href="#" title="LinkedIn">üíº</a>
          <a href="#" title="GitHub">üêô</a>
        </div>
      </div>
    </footer>
  </div>

  <script>
    // Sidebar navigation (single panel for now)
    const navItems = document.querySelectorAll('.nav-item');
    const panels = document.querySelectorAll('.panel');
    const welcome = document.getElementById('welcome');
    navItems.forEach(btn => {
      btn.addEventListener('click', () => {
        navItems.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        panels.forEach(p => p.classList.add('hidden'));
        const id = btn.getAttribute('data-panel');
        const panel = document.getElementById(id);
        if (welcome) welcome.classList.add('hidden');
        if (panel) panel.classList.remove('hidden');
      });
    });

    // Tabs switching
    const tabs = document.querySelectorAll('.tab');
    const views = {
      webcam: document.getElementById('view-webcam'),
      image: document.getElementById('view-image'),
      video: document.getElementById('view-video'),
      history: document.getElementById('view-history')
    };
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const key = tab.getAttribute('data-tab');
        Object.values(views).forEach(v => v.classList.add('hidden'));
        views[key].classList.remove('hidden');
      });
    });

    // Result helpers
    const resultBox = document.getElementById('result');
    const resultImg = document.getElementById('resultImage');
    const resultCount = document.getElementById('appleCount');
    function showResult(count, base64png) {
      resultCount.textContent = count;
      if (base64png) {
        resultImg.src = 'data:image/png;base64,' + base64png;
        resultBox.classList.remove('hidden');
      }
    }

    // History helpers (localStorage)
    const HISTORY_KEY = 'apple_history_v1';
    function readHistory() {
      try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); } catch { return []; }
    }
    function writeHistory(arr) { localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }
    function pushHistory(entry) {
      const arr = readHistory();
      arr.unshift(entry);
      writeHistory(arr);
      renderHistory();
    }
    function renderHistory() {
      const tbody = document.querySelector('#historyTable tbody');
      if (!tbody) return;
      const arr = readHistory();
      tbody.innerHTML = '';
      for (const row of arr) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="padding:8px 12px;">${row.type}</td>
                        <td style="padding:8px 12px;">${row.source || '-'}</td>
                        <td style="padding:8px 12px;">${row.start || '-'}</td>
                        <td style="padding:8px 12px;">${row.end || '-'}</td>
                        <td style="padding:8px 12px;">${row.count ?? '-'}</td>`;
        tbody.appendChild(tr);
      }
    }
    const clearHistoryBtn = document.getElementById('clearHistory');
    clearHistoryBtn && clearHistoryBtn.addEventListener('click', () => { writeHistory([]); renderHistory(); });
    renderHistory();

    // Webcam handling (start/pause/stop MJPEG <img>)
    const webcamImgTag = document.getElementById('webcamImgTag');
    const startImgStream = document.getElementById('startImgStream');
    const pauseImgStream = document.getElementById('pauseImgStream');
    const stopWebcamStream = document.getElementById('stopWebcamStream');

    // Start MJPEG using <img src="/apple/video_feed">
    startImgStream && startImgStream.addEventListener('click', async () => {
      const res = await fetch('/apple/webcam/start', { method: 'POST' });
      const json = await res.json();
      if (json.error) { alert(json.error); return; }
      window.__webcamStartTime = new Date();
      webcamImgTag.src = '/apple/video_feed?' + Date.now();
      webcamImgTag.style.display = 'block';
      resultBox.classList.add('hidden');
    });
    pauseImgStream && pauseImgStream.addEventListener('click', async () => {
      // Freeze current frame by fetching snapshot and setting it as img
      const res = await fetch('/apple/webcam/snapshot');
      const json = await res.json();
      if (json.image) {
        const endTime = new Date();
        webcamImgTag.src = 'data:image/png;base64,' + json.image;
        webcamImgTag.style.display = 'block';
        pushHistory({
          type: 'Webcam',
          source: 'Webcam',
          start: (window.__webcamStartTime || endTime).toLocaleString(),
          end: endTime.toLocaleString(),
          count: json.count ?? null
        });
      }
    });
    stopWebcamStream && stopWebcamStream.addEventListener('click', async () => {
      await fetch('/apple/webcam/stop', { method: 'POST' });
      if (webcamImgTag.src) {
        webcamImgTag.src = '';
        webcamImgTag.style.display = 'none';
      }
    });

    // Image upload
    const imageInput = document.getElementById('imageInput');
    const uploadImage = document.getElementById('uploadImage');
    uploadImage && uploadImage.addEventListener('click', async () => {
      if (!imageInput.files || !imageInput.files[0]) { alert('Choose an image'); return; }
      const form = new FormData();
      form.append('image', imageInput.files[0]);
      const res = await fetch('/apple/detect-image', { method: 'POST', body: form });
      const json = await res.json();
      if (json.error) { alert(json.error); return; }
      showResult(json.count, json.image);
      const now = new Date();
      pushHistory({ type: 'Image', source: imageInput.files[0]?.name || '-', start: now.toLocaleString(), end: now.toLocaleString(), count: json.count });
    });

    // Video upload
    const videoInput = document.getElementById('videoInput');
    const startFileStream = document.getElementById('startFileStream');
    const pauseFileStream = document.getElementById('pauseFileStream');
    const stopFileStream = document.getElementById('stopFileStream');
    const fileStreamImg = document.getElementById('fileStreamImg');

    // Start file streaming (cv2 loop + MJPEG)
    startFileStream && startFileStream.addEventListener('click', async () => {
      if (!videoInput.files || !videoInput.files[0]) { alert('Choose a video'); return; }
      const form = new FormData();
      form.append('video', videoInput.files[0]);
      const prep = await fetch('/apple/video/start', { method: 'POST', body: form });
      const json = await prep.json();
      if (json.error) { alert(json.error); return; }
      fileStreamImg.src = '/apple/video_feed_file?' + Date.now();
      fileStreamImg.style.display = 'block';
      resultBox.classList.add('hidden');
    });

    pauseFileStream && pauseFileStream.addEventListener('click', async () => {
      const res = await fetch('/apple/video/snapshot');
      const json = await res.json();
      if (json.image) {
        const endTime = new Date();
        fileStreamImg.src = 'data:image/png;base64,' + json.image;
        fileStreamImg.style.display = 'block';
        pushHistory({ type: 'Video', source: videoInput.files[0]?.name || '-', start: (window.__videoStartTime || endTime).toLocaleString(), end: endTime.toLocaleString(), count: json.count ?? null });
      }
    });

    stopFileStream && stopFileStream.addEventListener('click', async () => {
      await fetch('/apple/video/stop', { method: 'POST' });
      if (fileStreamImg.src) {
        fileStreamImg.src = '';
        fileStreamImg.style.display = 'none';
      }
    });
  </script>
</body>
</html>
